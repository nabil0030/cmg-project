<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DS Nord</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        input, select { padding: 5px; margin: 4px; }
        .alert { padding: 10px; margin-top: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error   { background-color: #f8d7da; color: #721c24; }
        button { margin-left: 8px; }
    </style>
</head>
<body>

<h2>DS Nord</h2>
<div id="message"></div>

<form id="formNord">
    <input type="hidden" id="id">

    Date: <input type="date" id="date" required>
    H Entr√©e: <input type="time" id="hEntree" required>
    H Sortie: <input type="time" id="hSortie" required>
    Transporteur:
    <select id="transporteur">
        <option>OUMJIRAN</option>
        <option>BOUDRHAM</option>
    </select>
    N¬∞ BL: <input type="text" id="numeroBL" required>
    Immatricule: <input type="text" id="immatricule" required>
    TB: <input type="number" step="0.01" id="tb" required>
    TARE: <input type="number" step="0.01" id="tare" required>
    POSTE:
    <select id="poste">
        <option>1</option><option>2</option><option>3</option>
    </select>
    Lieu De D√©charge: <input type="text" id="lieuDeDecharge" required>
    Observation: <input type="text" id="observation">

    <button type="submit">Ajouter / Mettre √† jour</button>
    <button type="button" onclick="exportExcel()">Exporter Excel</button>
</form>

<table id="tableNord">
    <thead>
    <tr>
        <th>Date</th><th>H Entr√©e</th><th>H Sortie</th>
        <th>Transporteur</th><th>N¬∞ BL</th><th>Immatricule</th>
        <th>TB</th><th>TARE</th><th>NET</th><th>Poste</th>
        <th>Lieu De D√©charge</th><th>Observation</th><th>Actions</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    const api = "/api/dsnord";

    function showMessage(msg, type) {
        const div = document.getElementById("message");
        div.innerHTML = `<div class="alert ${type}">${msg}</div>`;
        setTimeout(() => div.innerHTML = "", 4000);
    }

    document.getElementById("formNord").addEventListener("submit", async e => {
        e.preventDefault();
        const rec = {
            id: document.getElementById("id").value||null,
            date: document.getElementById("date").value,
            hEntree: document.getElementById("hEntree").value,
            hSortie: document.getElementById("hSortie").value,
            transporteur: document.getElementById("transporteur").value,
            numeroBL: document.getElementById("numeroBL").value,
            immatricule: document.getElementById("immatricule").value,
            tb: parseFloat(document.getElementById("tb").value),
            tare: parseFloat(document.getElementById("tare").value),
            poste: parseInt(document.getElementById("poste").value),
            lieuDeDecharge: document.getElementById("lieuDeDecharge").value,
            observation: document.getElementById("observation").value
        };
        try {
            // POST for create, PUT for update
            let res;
            if (rec.id) {
                res = await axios.put(`${api}/${rec.id}`, rec);
            } else {
                res = await axios.post(api, rec);
            }
            const msg = typeof res.data === 'string' ? res.data : "‚úÖ Op√©ration r√©ussie.";
            const type = msg.includes("dupliqu√©e") ? "error" : "success";
            showMessage(msg, type);
            if (type==="success") {
                document.getElementById("formNord").reset();
                document.getElementById("id").value = "";
                loadData();
            }
        } catch (err) {
            showMessage("Erreur‚Äâ: " + err.message, "error");
        }
    });

    async function loadData() {
        try {
            const res = await axios.get(api);
            const tbody = document.querySelector("#tableNord tbody");
            tbody.innerHTML = "";
            res.data.forEach(item => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${item.date}</td>
            <td>${item.hEntree?.substring(0,5)||""}</td>
            <td>${item.hSortie?.substring(0,5)||""}</td>
            <td>${item.transporteur}</td>
            <td>${item.numeroBL}</td>
            <td>${item.immatricule}</td>
            <td>${item.tb}</td>
            <td>${item.tare}</td>
            <td>${item.net}</td>
            <td>${item.poste}</td>
            <td>${item.lieuDeDecharge}</td>
            <td>${item.observation||""}</td>
            <td>
              <button onclick='edit(${JSON.stringify(item)})'>‚úèÔ∏è</button>
              <button onclick='remove(${item.id})'>üóëÔ∏è</button>
            </td>`;
                tbody.appendChild(tr);
            });
        } catch (e) {
            showMessage("Erreur chargement‚Äâ: "+e.message, "error");
        }
    }

    function edit(item) {
        document.getElementById("id").value = item.id;
        document.getElementById("date").value = item.date;
        document.getElementById("hEntree").value = item.hEntree?.substring(0,5);
        document.getElementById("hSortie").value = item.hSortie?.substring(0,5);
        document.getElementById("transporteur").value = item.transporteur;
        document.getElementById("numeroBL").value = item.numeroBL;
        document.getElementById("immatricule").value = item.immatricule;
        document.getElementById("tb").value = item.tb;
        document.getElementById("tare").value = item.tare;
        document.getElementById("poste").value = item.poste;
        document.getElementById("lieuDeDecharge").value = item.lieuDeDecharge;
        document.getElementById("observation").value = item.observation;
    }

    async function remove(id) {
        if (confirm("Supprimer cette ligne‚Äâ?")) {
            await axios.delete(`${api}/${id}`);
            loadData();
        }
    }

    function exportExcel() {
        window.location.href = "/api/dsnord/export/excel";
    }

    // on page load
    loadData();
</script>

</body>
</html>
